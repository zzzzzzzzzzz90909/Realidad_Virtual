<!DOCTYPE html>
<html>
<head>
  <title>Planta Industrial - Brazo Robótico GP12_AR1440</title>
  <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/20.0.3/tween.umd.js"></script>
  <script>
    /* global AFRAME, TWEEN, THREE */

    AFRAME.registerComponent('robot-controller', {
      init: function () {
        this.robot = null;
        this.box = document.querySelector('#box-to-move').object3D;
        this.isAnimationRunning = false;
        this.joints = [];

        const robotEntity = document.querySelector('#robot');
        robotEntity.addEventListener('model-loaded', this.onModelLoaded.bind(this));
        robotEntity.addEventListener('error', this.onModelError.bind(this));
      },

      onModelError: function (e) {
        console.error("Error al cargar el modelo del robot:", e.detail);
        this.createFallbackRobot();
      },

      createFallbackRobot: function () {
        console.log("Creando modelo de respaldo del robot...");
        const robotEntity = document.querySelector('#robot');
        
        // Crear un brazo robótico básico con primitivas de A-Frame
        const base = document.createElement('a-cylinder');
        base.setAttribute('color', '#333333');
        base.setAttribute('radius', '0.3');
        base.setAttribute('height', '0.2');
        base.setAttribute('position', '0 0.1 0');
        base.setAttribute('id', 'base');
        robotEntity.appendChild(base);
        
        const arm1 = document.createElement('a-box');
        arm1.setAttribute('color', '#666666');
        arm1.setAttribute('width', '0.2');
        arm1.setAttribute('height', '0.8');
        arm1.setAttribute('depth', '0.2');
        arm1.setAttribute('position', '0 0.6 0');
        arm1.setAttribute('id', 'arm1');
        robotEntity.appendChild(arm1);
        
        const arm2 = document.createElement('a-box');
        arm2.setAttribute('color', '#888888');
        arm2.setAttribute('width', '0.15');
        arm2.setAttribute('height', '0.6');
        arm2.setAttribute('depth', '0.15');
        arm2.setAttribute('position', '0 1.2 0.3');
        arm2.setAttribute('rotation', '0 0 45');
        arm2.setAttribute('id', 'arm2');
        robotEntity.appendChild(arm2);
        
        const gripper = document.createElement('a-box');
        gripper.setAttribute('color', '#AAAAAA');
        gripper.setAttribute('width', '0.3');
        gripper.setAttribute('height', '0.1');
        gripper.setAttribute('depth', '0.1');
        gripper.setAttribute('position', '0 1.5 0.5');
        gripper.setAttribute('id', 'gripper');
        robotEntity.appendChild(gripper);
        
        // Simular que el modelo está cargado
        setTimeout(() => {
          this.onModelLoaded({detail: {model: robotEntity.object3D}});
        }, 500);
      },

      onModelLoaded: function (e) {
        this.robot = e.detail.model;
        console.log("Modelo GP12_AR1440 cargado. Buscando articulaciones...");

        // Búsqueda mejorada de articulaciones para el modelo GP12_AR1440
        this.findJoints();

        console.log("Se encontraron " + this.joints.length + " articulaciones.");
        this.joints.forEach((joint, index) => {
          console.log("Articulación " + index + ": " + joint.name);
        });

        // Si no encontramos articulaciones, usar búsqueda alternativa
        if (this.joints.length < 3) {
          console.warn("Búsqueda principal falló. Usando búsqueda alternativa...");
          this.findJointsAlternative();
          console.log("Búsqueda alternativa: " + this.joints.length + " articulaciones encontradas.");
        }

        // Si aún no tenemos articulaciones, usar modelo de respaldo
        if (this.joints.length < 3) {
          console.warn("No se encontraron suficientes articulaciones. Usando modelo de respaldo.");
          this.createFallbackRobot();
          return;
        }

        console.log("Iniciando secuencia de animación automática en 2 segundos...");
        setTimeout(() => {
          this.startFullSequence();
        }, 2000);
      },

      findJoints: function() {
        this.joints = [];
        
        // Búsqueda específica para el modelo GP12_AR1440
        this.robot.traverse(node => {
          // Buscar por nombres comunes en modelos robóticos
          if (node.isBone || node.isGroup || node.isObject3D) {
            const name = node.name ? node.name.toLowerCase() : '';
            
            // Patrones comunes en nombres de articulaciones robóticas
            if (name.includes('base') || name.includes('root') || name.includes('joint1')) {
              if (!this.joints.includes(node)) {
                this.joints[0] = node; // Base
              }
            }
            else if (name.includes('shoulder') || name.includes('link1') || name.includes('joint2')) {
              if (!this.joints.includes(node)) {
                this.joints[1] = node; // Hombro
              }
            }
            else if (name.includes('elbow') || name.includes('link2') || name.includes('joint3')) {
              if (!this.joints.includes(node)) {
                this.joints[2] = node; // Codo
              }
            }
            else if (name.includes('wrist') || name.includes('link3') || name.includes('joint4')) {
              if (!this.joints.includes(node)) {
                this.joints[3] = node; // Muñeca
              }
            }
            else if (name.includes('hand') || name.includes('gripper') || name.includes('end')) {
              if (!this.joints.includes(node)) {
                this.joints[4] = node; // Pinza
              }
            }
          }
        });

        // Filtrar elementos undefined y ordenar
        this.joints = this.joints.filter(joint => joint !== undefined);
      },

      findJointsAlternative: function() {
        this.joints = [];
        
        // Búsqueda alternativa - todos los objetos con transformaciones
        this.robot.traverse(node => {
          if ((node.type === 'Object3D' || node.type === 'Group' || node.isBone) && 
              node.name && node !== this.robot) {
            // Priorizar objetos que probablemente sean articulaciones
            if (node.name.match(/joint|link|arm|base|shoulder|elbow|wrist|gripper/i)) {
              this.joints.push(node);
            }
          }
        });

        // Si aún no tenemos suficientes, agregar más objetos
        if (this.joints.length < 3) {
          this.robot.traverse(node => {
            if ((node.type === 'Object3D' || node.type === 'Group' || node.isBone) && 
                node.name && node !== this.robot && !this.joints.includes(node)) {
              this.joints.push(node);
            }
          });
        }

        // Limitar a 6 articulaciones máximo para evitar problemas
        this.joints = this.joints.slice(0, 6);
      },

      createTween: function (joint, to, duration = 1500) {
        const from = { 
          x: joint.rotation.x || 0, 
          y: joint.rotation.y || 0, 
          z: joint.rotation.z || 0 
        };
        
        const toRad = {
          x: THREE.MathUtils.degToRad(to.x !== undefined ? to.x : THREE.MathUtils.radToDeg(from.x)),
          y: THREE.MathUtils.degToRad(to.y !== undefined ? to.y : THREE.MathUtils.radToDeg(from.y)),
          z: THREE.MathUtils.degToRad(to.z !== undefined ? to.z : THREE.MathUtils.radToDeg(from.z)),
        };

        return new TWEEN.Tween(from)
          .to(toRad, duration)
          .onUpdate(() => {
            if (joint) {
              joint.rotation.set(from.x, from.y, from.z);
            }
          })
          .easing(TWEEN.Easing.Quadratic.InOut);
      },

      startFullSequence: function () {
        if (this.isAnimationRunning) return;
        this.isAnimationRunning = true;

        console.log("Iniciando secuencia de animación con " + this.joints.length + " articulaciones");

        // Asegurarse de que tenemos suficientes articulaciones
        if (this.joints.length < 3) {
          console.error("No hay suficientes articulaciones para la animación.");
          this.isAnimationRunning = false;
          return;
        }

        const [base, shoulder, elbow, wrist, gripper] = this.joints;

        // Secuencia de movimientos adaptada para el modelo GP12_AR1440
        const moveToBox = this.createTween(base, { y: -45 })
          .chain(this.createTween(shoulder, { x: -35 }))
          .chain(this.createTween(elbow, { x: 60 }));

        // Agregar articulación de muñeca si está disponible
        if (wrist) {
          moveToBox.chain(this.createTween(wrist, { x: -25 }));
        }

        const grabBox = this.createTween(shoulder, { x: -25 })
          .chain(this.createTween(elbow, { x: 40 }));

        const moveToDropzone = this.createTween(base, { y: 50 }, 2000)
          .chain(this.createTween(shoulder, { x: -35 }))
          .chain(this.createTween(elbow, { x: 60 }));

        const releaseBox = this.createTween(shoulder, { x: -25 })
          .chain(this.createTween(elbow, { x: 40 }));

        const returnToHome = this.createTween(base, { y: 0 }, 2000)
          .chain(this.createTween(shoulder, { x: 0 }))
          .chain(this.createTween(elbow, { x: 0 }));

        // Agregar articulación de muñeca si está disponible
        if (wrist) {
          returnToHome.chain(this.createTween(wrist, { x: 0 }));
        }

        // Encadenar secuencias
        moveToBox.chain(grabBox);
        grabBox.chain(moveToDropzone);
        moveToDropzone.chain(releaseBox);
        releaseBox.chain(returnToHome);

        // Acciones especiales para agarrar y soltar
        grabBox.onStart(() => {
          console.log("Agarrando la caja...");
          if (gripper) {
            const boxEntity = document.querySelector('#box-to-move');
            // Posicionar la caja relativa a la pinza
            boxEntity.object3D.position.set(0, 0, 0);
            gripper.add(boxEntity.object3D);
          }
        });

        releaseBox.onStart(() => {
          console.log("Soltando la caja...");
          const boxEntity = document.querySelector('#box-to-move');
          // Colocar la caja en la zona de destino (pallet)
          this.el.sceneEl.object3D.add(boxEntity.object3D);
          boxEntity.setAttribute('position', '1.8 0.9 -1.5');
        });

        returnToHome.onComplete(() => {
          console.log("Secuencia completada.");
          this.isAnimationRunning = false;
          
          // Reiniciar la animación después de 3 segundos
          setTimeout(() => {
            if (!this.isAnimationRunning) {
              console.log("Reiniciando animación...");
              this.startFullSequence();
            }
          }, 3000);
        });

        // Iniciar animación
        moveToBox.start();
      },

      tick: function (time, timeDelta) {
        TWEEN.update(time);
      }
    });
  </script>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      overflow: hidden;
    }
    .info-panel {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 10px;
      border-radius: 5px;
      z-index: 1000;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="info-panel">
    <h3>Brazo Robótico GP12_AR1440</h3>
    <p>Animación automática en ejecución</p>
    <p>Use WASD y mouse para navegar</p>
  </div>

  <a-scene background="color: #454545" robot-controller renderer="colorManagement: true; physicallyCorrectLights: true">

    <a-assets>
      <a-asset-item id="robot-arm" src="./GP12_AR1440.glb"></a-asset-item>
      <img id="concrete-floor" src="https://cdn.glitch.global/c67f1742-8280-4962-a78b-d547370c4a4a/Concrete031_1K_Color.jpg?v=1680522802651">
      <img id="metal-wall" src="https://cdn.glitch.global/c67f1742-8280-4962-a78b-d547370c4a4a/MetalPlates006_1K_Color.jpg?v=1680522810486">
      <img id="conveyor-texture" src="https://cdn.glitch.global/c67f1742-8280-4962-a78b-d547370c4a4a/Rubber001_1K_Color.jpg?v=1680522815664">
      <img id="warning-sign" src="https://cdn.glitch.global/c67f1742-8280-4962-a78b-d547370c4a4a/robot-warning-sign.png?v=1680524891823">
      <img id="wood-pallet" src="https://cdn.glitch.global/c67f1742-8280-4962-a78b-d547370c4a4a/Planks032_1K_Color.jpg?v=1680526462589">
      <img id="screen-ui" src="https://cdn.glitch.global/c67f1742-8280-4962-a78b-d547370c4a4a/scifi-screen.jpg?v=1680526458653">
    </a-assets>

    <a-entity light="type: ambient; color: #AAA; intensity: 1"></a-entity>
    <a-entity light="type: directional; color: #FFF; intensity: 0.8" position="-2 5 2" castShadow></a-entity>
    <a-entity light="type: spot; angle: 50; penumbra: 0.5; intensity: 2.5; castShadow: true;" position="0 4 0"></a-entity>
    
    <a-plane material="src: #concrete-floor; repeat: 5 5; color: #E0E0E0" position="0 0 0" rotation="-90 0 0" width="10" height="10" shadow="receive: true"></a-plane>
    <a-plane material="src: #metal-wall; repeat: 4 2; color: #D0D0D0" width="10" height="5" position="0 2.5 -5"></a-plane>
    <a-plane material="src: #metal-wall; repeat: 4 2; color: #D0D0D0" width="10" height="5" position="-5 2.5 0" rotation="0 90 0"></a-plane>
    <a-plane color="#3a86ff" width="6" height="0.15" position="-2 0.01 2.5" rotation="-90 0 0"></a-plane>
    <a-plane color="#3a86ff" width="0.15" height="5" position="1 0.01 0" rotation="-90 0 0"></a-plane>

    <a-entity id="robot" gltf-model="#robot-arm" position="0 0.5 0" scale="0.8 0.8 0.8" shadow="cast: true"></a-entity>
    
    <a-entity id="conveyor-belt" position="-1.8 0.4 0" rotation="0 90 0">
      <a-box color="#333" depth="3" height="0.6" width="0.8"></a-box>
      <a-box id="conveyor-band" material="src: #conveyor-texture; repeat: 3 1" position="0 0.35 0" depth="3" height="0.1" width="0.7"></a-box>
    </a-entity>
    
    <a-box id="box-to-move" position="-1.8 0.9 0" depth="0.4" height="0.4" width="0.4" color="tomato" shadow="cast: true"></a-box>
    
    <a-entity id="pallet" position="1.8 0 -1.5" shadow="cast: true">
      <a-box material="src: #wood-pallet" width="1.2" height="0.15" depth="1.0" position="0 0.075 0"></a-box>
    </a-entity>
    
    <a-entity id="operator-station" position="3.5 0 2.5">
      <a-box color="#7d8597" width="1.5" height="0.1" depth="0.8" position="0 1 0" shadow="cast: true"></a-box>
      <a-box color="#4a4e69" width="0.1" height="1" depth="0.1" position="-0.7 0.5 -0.35"></a-box>
      <a-box color="#4a4e69" width="0.1" height="1" depth="0.1" position="0.7 0.5 -0.35"></a-box>
      <a-box color="#222" width="0.9" height="0.6" depth="0.05" position="0 1.35 -0.3" shadow="cast: true"></a-box>
      <a-plane material="src: #screen-ui" width="0.8" height="0.5" position="0 1.35 -0.27"></a-plane>
      <a-cylinder color="#6c757d" radius="0.25" height="0.6" position="0 0.3 0.6" shadow="cast: true"></a-cylinder>
    </a-entity>

    <a-box color="#555" width="10" height="0.2" depth="0.2" position="0 5 -2.5"></a-box>
    <a-box color="#555" width="10" height="0.2" depth="0.2" position="-2.5 5 0" rotation="0 90 0"></a-box>

    <a-entity position="0 3 0">
      <a-cylinder color="#ffb703" radius="0.15" height="0.2"></a-cylinder>
      <a-light type="point" color="#ffb703" intensity="3" distance="5" animation="property: rotation; to: 0 360 0; loop: true; dur: 2000; easing: linear"></a-light>
    </a-entity>
    
    <a-entity position="-4.8 0.5 2">
      <a-cylinder color="#d90429" radius="0.1" height="0.6" shadow="cast: true"></a-cylinder>
      <a-box color="#2b2d42" width="0.05" height="0.1" depth="0.15" position="0 0.2 0.08"></a-box>
    </a-entity>
    
    <a-cylinder color="#A5A5A5" radius="0.1" height="10" position="-4.9 4 0" rotation="90 0 0"></a-cylinder>
    <a-cylinder color="#A5A5A5" radius="0.1" height="10" position="0 4 -4.9" rotation="0 0 90"></a-cylinder>
    
    <a-entity position="-3 1.5 -4.8">
      <a-box color="#3d5a80" width="0.6" height="0.8" depth="0.2" shadow="cast: true"></a-box>
      <a-cylinder color="#e63946" radius="0.08" height="0.1" position="0 0 0.11" rotation="90 0 0"></a-cylinder>
    </a-entity>
    
    <a-plane material="src: #warning-sign" width="1" height="1" position="2 2 -4.9"></a-plane>

    <a-entity camera look-controls wasd-controls position="0 1.8 4" fov="65"></a-entity>
    
  </a-scene>
</body>
</html>
