<!DOCTYPE html>
<html>
<head>
  <title>Planta Industrial v4 - Brazo RobÃ³tico</title>
  <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/20.0.3/tween.umd.js"></script>
  <script>
    /* global AFRAME, TWEEN, THREE */

    AFRAME.registerComponent('robot-controller', {
      init: function () {
        this.robot = null;
        this.box = document.querySelector('#box-to-move').object3D;
        this.isAnimationRunning = false;
        
        // Articulaciones especÃ­ficas del modelo GP12
        this.baseAxis = null;
        this.sAxis = null;
        this.lAxis = null;
        this.uAxis = null;
        this.rAxis = null;
        this.bAxis = null;

        const robotEntity = document.querySelector('#robot');
        robotEntity.addEventListener('model-loaded', this.onModelLoaded.bind(this));
      },

      onModelLoaded: function (e) {
        this.robot = e.detail.model;
        console.log("Modelo GP12 cargado. Buscando articulaciones especÃ­ficas...");
        console.log("==================== LISTADO COMPLETO DE NODOS ====================");

        // Primero, listar TODOS los nodos para ver quÃ© tenemos
        this.robot.traverse(node => {
          if (node.name) {
            console.log(`  ðŸ“¦ ${node.name} (tipo: ${node.type})`);
          }
        });

        console.log("==================== FIN DEL LISTADO ====================");

        // Buscar articulaciones especÃ­ficas del GP12 por nombre
        this.baseAxis = null;
        this.sAxis = null;
        this.lAxis = null;
        this.uAxis = null;
        this.rAxis = null;
        this.bAxis = null;

        this.robot.traverse(node => {
          if (node.name === 'GP12_AR1440' || node.name === 'GP12_AR1440STEP') {
            this.baseAxis = node;
            console.log("âœ“ Encontrado: GP12_AR1440 (Base)", node);
          } else if (node.name === 'GP12_S_AXIS_GP12_AR1440STEP-1') {
            this.sAxis = node;
            console.log("âœ“ Encontrado: GP12_S_AXIS (Shoulder)", node);
          } else if (node.name === 'GP12_L_AXIS_GP12_AR1440_StandardSTEP-1') {
            this.lAxis = node;
            console.log("âœ“ Encontrado: GP12_L_AXIS (Lower)", node);
          } else if (node.name === 'GP12_U_AXIS_GP12_AR1440_StandardSTEP-1') {
            this.uAxis = node;
            console.log("âœ“ Encontrado: GP12_U_AXIS (Upper)", node);
          } else if (node.name === 'GP12_R_AXIS_GP12_AR1440_StandardSTEP-1') {
            this.rAxis = node;
            console.log("âœ“ Encontrado: GP12_R_AXIS (Rotation)", node);
          } else if (node.name === 'GP12_B_AXIS_GP12_AR1440_StandardSTEP-1') {
            this.bAxis = node;
            console.log("âœ“ Encontrado: GP12_B_AXIS (Bend)", node);
          }
        });

        // Validar que se encontraron las articulaciones
        if (!this.baseAxis || !this.sAxis || !this.lAxis) {
          console.error("âŒ No se encontraron todas las articulaciones necesarias:");
          console.log("  Base:", this.baseAxis ? "âœ“" : "âœ—");
          console.log("  S-Axis:", this.sAxis ? "âœ“" : "âœ—");
          console.log("  L-Axis:", this.lAxis ? "âœ“" : "âœ—");
          console.log("\nðŸ’¡ Copia los nombres exactos de arriba y dÃ­melos para actualizarlos.");
          return;
        }

        console.log("âœ“ Todas las articulaciones GP12 encontradas correctamente");
        console.log("Iniciando secuencia de animaciÃ³n en 1 segundo...");
        setTimeout(() => {
          this.startFullSequence();
        }, 1000);
      },

      createTween: function (joint, to, duration = 1500) {
        const from = { x: joint.rotation.x, y: joint.rotation.y, z: joint.rotation.z };
        const toRad = {
          x: THREE.MathUtils.degToRad(to.x ?? THREE.MathUtils.radToDeg(from.x)),
          y: THREE.MathUtils.degToRad(to.y ?? THREE.MathUtils.radToDeg(from.y)),
          z: THREE.MathUtils.degToRad(to.z ?? THREE.MathUtils.radToDeg(from.z)),
        };

        return new TWEEN.Tween(from)
          .to(toRad, duration)
          .onUpdate(() => {
            joint.rotation.set(from.x, from.y, from.z);
          })
          .easing(TWEEN.Easing.Quadratic.InOut);
      },

      startFullSequence: function () {
        if (this.isAnimationRunning) return;
        this.isAnimationRunning = true;

        console.log("Iniciando secuencia de movimiento GP12...");

        // PosiciÃ³n de la caja en el pallet (CORREGIDA)
        const palletPosition = new THREE.Vector3(1.8, 0.22, -1.5);

        // SECUENCIA MEJORADA - MOVIMIENTO COORDINADO DE TODAS LAS ARTICULACIONES
        
        // 1. MOVIMIENTO HACIA LA CAJA (todas las articulaciones se mueven coordinadamente)
        const moveToBox = this.createTween(this.baseAxis, { y: -60 }, 1800)
          .chain(this.createTween(this.sAxis, { z: -40 }, 1200))
          .chain(this.createTween(this.lAxis, { z: 60 }, 1200))
          .chain(this.createTween(this.uAxis, { z: 20 }, 800))
          .onStart(() => console.log("ðŸ”„ Moviendo todas las articulaciones hacia la caja..."));

        // 2. AGARRAR LA CAJA (movimiento coordinado de aproximaciÃ³n)
        const approachBox = this.createTween(this.sAxis, { z: -50 }, 800)
          .chain(this.createTween(this.lAxis, { z: 70 }, 800))
          .chain(this.createTween(this.uAxis, { z: 10 }, 600));

        // 3. AGARRAR LA CAJA (movimiento final de agarre)
        const grabBox = this.createTween(this.sAxis, { z: -45 }, 600)
          .chain(this.createTween(this.lAxis, { z: 65 }, 600))
          .onStart(() => {
            console.log("ðŸŽ¯ Agarre coordinado de la caja...");
            // Usar la articulaciÃ³n mÃ¡s adecuada para agarrar
            const gripper = this.bAxis || this.rAxis || this.lAxis;
            if (gripper) {
              gripper.attach(this.box);
            }
          });

        // 4. LEVANTAR LA CAJA (movimiento coordinado de elevaciÃ³n)
        const liftBox = this.createTween(this.sAxis, { z: -30 }, 1000)
          .chain(this.createTween(this.lAxis, { z: 50 }, 1000))
          .chain(this.createTween(this.uAxis, { z: 30 }, 800))
          .onStart(() => console.log("â¬†ï¸ Levantando caja coordinadamente..."));

        // 5. MOVER HACIA EL PALLET (rotaciÃ³n coordinada)
        const moveToPallet = this.createTween(this.baseAxis, { y: 50 }, 2000)
          .chain(this.createTween(this.sAxis, { z: -25 }, 800))
          .chain(this.createTween(this.lAxis, { z: 45 }, 800))
          .onStart(() => console.log("ðŸ”„ Rotando hacia el pallet..."));

        // 6. POSICIONAR SOBRE EL PALLET (movimiento coordinado de descenso)
        const positionOverPallet = this.createTween(this.sAxis, { z: -40 }, 1000)
          .chain(this.createTween(this.lAxis, { z: 60 }, 1000))
          .chain(this.createTween(this.uAxis, { z: 15 }, 600))
          .onStart(() => console.log("ðŸ“¦ Posicionando sobre el pallet..."));

        // 7. SOLTAR LA CAJA (movimiento coordinado de liberaciÃ³n)
        const releaseBox = this.createTween(this.sAxis, { z: -35 }, 600)
          .chain(this.createTween(this.lAxis, { z: 55 }, 600))
          .onStart(() => {
            console.log("ðŸ”„ Liberando caja en el pallet...");
            // Devolver la caja a la escena principal
            this.el.sceneEl.object3D.attach(this.box);
            // POSICIÃ“N CORREGIDA - en el pallet
            this.box.position.copy(palletPosition);
          });

        // 8. RETIRAR BRAZO (movimiento coordinado de retirada)
        const retractArm = this.createTween(this.sAxis, { z: -20 }, 800)
          .chain(this.createTween(this.lAxis, { z: 40 }, 800))
          .chain(this.createTween(this.uAxis, { z: 25 }, 600))
          .onStart(() => console.log("â†—ï¸ Retirando brazo coordinadamente..."));

        // 9. VOLVER A POSICIÃ“N INICIAL (movimiento coordinado completo)
        const returnToHome = this.createTween(this.baseAxis, { y: 0 }, 1800)
          .chain(this.createTween(this.sAxis, { z: 0 }, 1200))
          .chain(this.createTween(this.lAxis, { z: 0 }, 1200))
          .chain(this.createTween(this.uAxis, { z: 0 }, 800))
          .onComplete(() => {
            console.log("âœ… Secuencia completada. Reiniciando en 3 segundos...");
            this.isAnimationRunning = false;
            
            // REINICIAR LA ANIMACIÃ“N despuÃ©s de 3 segundos
            setTimeout(() => {
              console.log("ðŸ”„ Reiniciando secuencia completa...");
              // Resetear posiciÃ³n de la caja al conveyor
              this.box.position.set(-1.8, 0.9, 0);
              this.startFullSequence();
            }, 3000);
          });

        // ENCADENAR TODA LA SECUENCIA COORDINADA
        moveToBox.chain(approachBox);
        approachBox.chain(grabBox);
        grabBox.chain(liftBox);
        liftBox.chain(moveToPallet);
        moveToPallet.chain(positionOverPallet);
        positionOverPallet.chain(releaseBox);
        releaseBox.chain(retractArm);
        retractArm.chain(returnToHome);

        // Iniciar la animaciÃ³n
        moveToBox.start();
      },

      tick: function (time, timeDelta) {
        TWEEN.update(time);
      }
    });
  </script>
</head>
<body>
  <a-scene background="color: #454545" robot-controller renderer="colorManagement: true; physicallyCorrectLights: true">

    <a-assets>
      <a-asset-item id="robot-arm" src="./GP12_AR1440.glb"></a-asset-item>
      <img id="concrete-floor" src="https://cdn.glitch.global/c67f1742-8280-4962-a78b-d547370c4a4a/Concrete031_1K_Color.jpg?v=1680522802651">
      <img id="metal-wall" src="https://cdn.glitch.global/c67f1742-8280-4962-a78b-d547370c4a4a/MetalPlates006_1K_Color.jpg?v=1680522810486">
      <img id="conveyor-texture" src="https://cdn.glitch.global/c67f1742-8280-4962-a78b-d547370c4a4a/Rubber001_1K_Color.jpg?v=1680522815664">
      <img id="warning-sign" src="https://cdn.glitch.global/c67f1742-8280-4962-a78b-d547370c4a4a/robot-warning-sign.png?v=1680524891823">
      <img id="wood-pallet" src="https://cdn.glitch.global/c67f1742-8280-4962-a78b-d547370c4a4a/Planks032_1K_Color.jpg?v=1680526462589">
      <img id="screen-ui" src="https://cdn.glitch.global/c67f1742-8280-4962-a78b-d547370c4a4a/scifi-screen.jpg?v=1680526458653">
    </a-assets>

    <a-entity light="type: ambient; color: #AAA; intensity: 1"></a-entity>
    <a-entity light="type: directional; color: #FFF; intensity: 0.8" position="-2 5 2"></a-entity>
    <a-entity light="type: spot; angle: 50; penumbra: 0.5; intensity: 2.5; castShadow: true;" position="0 4 0"></a-entity>
    
    <a-plane material="src: #concrete-floor; repeat: 5 5; color: #E0E0E0" position="0 0 0" rotation="-90 0 0" width="10" height="10" shadow="receive: true"></a-plane>
    <a-plane material="src: #metal-wall; repeat: 4 2; color: #D0D0D0" width="10" height="5" position="0 2.5 -5"></a-plane>
    <a-plane material="src: #metal-wall; repeat: 4 2; color: #D0D0D0" width="10" height="5" position="-5 2.5 0" rotation="0 90 0"></a-plane>
    <a-plane color="#3a86ff" width="6" height="0.15" position="-2 0.01 2.5" rotation="-90 0 0"></a-plane>
    <a-plane color="#3a86ff" width="0.15" height="5" position="1 0.01 0" rotation="-90 0 0"></a-plane>

    <a-entity id="robot" gltf-model="#robot-arm" position="0 0 0" shadow="cast: true"></a-entity>
    
    <a-entity id="conveyor-belt" position="-1.8 0.4 0" rotation="0 90 0">
      <a-box color="#333" depth="3" height="0.6" width="0.8"></a-box>
      <a-box id="conveyor-band" material="src: #conveyor-texture; repeat: 3 1" position="0 0.35 0" depth="3" height="0.1" width="0.7"></a-box>
    </a-entity>
    
    <a-box id="box-to-move" position="-1.8 0.9 0" depth="0.4" height="0.4" width="0.4" color="tomato" shadow="cast: true"></a-box>
    
    <a-entity id="pallet" position="1.8 0 -1.5" shadow="cast: true">
      <a-box material="src: #wood-pallet" width="1.2" height="0.15" depth="1.0" position="0 0.075 0"></a-box>
    </a-entity>
    
    <a-entity id="operator-station" position="3.5 0 2.5">
      <a-box color="#7d8597" width="1.5" height="0.1" depth="0.8" position="0 1 0" shadow="cast: true"></a-box>
      <a-box color="#4a4e69" width="0.1" height="1" depth="0.1" position="-0.7 0.5 -0.35"></a-box>
      <a-box color="#4a4e69" width="0.1" height="1" depth="0.1" position="0.7 0.5 -0.35"></a-box>
      <a-box color="#222" width="0.9" height="0.6" depth="0.05" position="0 1.35 -0.3" shadow="cast: true"></a-box>
      <a-plane material="src: #screen-ui" width="0.8" height="0.5" position="0 1.35 -0.27"></a-plane>
      <a-cylinder color="#6c757d" radius="0.25" height="0.6" position="0 0.3 0.6" shadow="cast: true"></a-cylinder>
    </a-entity>

    <a-box color="#555" width="10" height="0.2" depth="0.2" position="0 5 -2.5"></a-box>
    <a-box color="#555" width="10" height="0.2" depth="0.2" position="-2.5 5 0" rotation="0 90 0"></a-box>

    <a-entity position="0 3 0">
      <a-cylinder color="#ffb703" radius="0.15" height="0.2"></a-cylinder>
      <a-light type="point" color="#ffb703" intensity="3" distance="5" animation="property: rotation; to: 0 360 0; loop: true; dur: 2000; easing: linear"></a-light>
    </a-entity>
    
    <a-entity position="-4.8 0.5 2">
      <a-cylinder color="#d90429" radius="0.1" height="0.6" shadow="cast: true"></a-cylinder>
      <a-box color="#2b2d42" width="0.05" height="0.1" depth="0.15" position="0 0.2 0.08"></a-box>
    </a-entity>
    
    <a-cylinder color="#A5A5A5" radius="0.1" height="10" position="-4.9 4 0" rotation="90 0 0"></a-cylinder>
    <a-cylinder color="#A5A5A5" radius="0.1" height="10" position="0 4 -4.9" rotation="0 0 90"></a-cylinder>
    
    <a-entity position="-3 1.5 -4.8">
      <a-box color="#3d5a80" width="0.6" height="0.8" depth="0.2" shadow="cast: true"></a-box>
      <a-cylinder color="#e63946" radius="0.08" height="0.1" position="0 0 0.11" rotation="90 0 0"></a-cylinder>
    </a-entity>
    
    <a-plane material="src: #warning-sign" width="1" height="1" position="2 2 -4.9"></a-plane>

    <a-entity camera look-controls wasd-controls position="0 1.8 4" fov="65"></a-entity>
    
  </a-scene>
</body>
</html>
