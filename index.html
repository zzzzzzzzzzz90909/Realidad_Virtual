<!DOCTYPE html>
<html>
<head>
  <title>Planta Industrial - Yaskawa AR1440</title>
  <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/20.0.3/tween.umd.js"></script>

  <script>
    /* global AFRAME, TWEEN, THREE */

    AFRAME.registerComponent('robot-controller', {
      init: function () {
        this.sceneEl = this.el;
        this.robot = null;
        this.joints = {}; // Usamos un objeto para guardar las articulaciones por NOMBRE
        this.placedBoxCount = 0;
        
        this.pickupPosition = new THREE.Vector3(-1.8, 0.9, 0);
        this.conveyorStartPosition = new THREE.Vector3(-1.8, 0.9, 1.4);
        this.palletPositions = [
            new THREE.Vector3(1.5, 0.22, -1.2), new THREE.Vector3(2.1, 0.22, -1.2),
            new THREE.Vector3(1.5, 0.62, -1.2), new THREE.Vector3(2.1, 0.62, -1.2),
        ];

        // --- NOMBRES ACTUALIZADOS PARA EL ROBOT YASKAWA AR1440 ---
        this.jointNames = [
          'GP12_BASE_AXIS_GP12_AR1440_Standard.STEP-1',
          'GP12_S_AXIS_GP12_AR1440.STEP-1',
          'GP12_L_AXIS_GP12_AR1440_Standard.STEP-1',
          'GP12_U_AXIS_GP12_AR1440_Standard.STEP-1',
          'GP12_R_AXIS_GP12_AR1440_Standard.STEP-1',
          'GP12_B_AXIS_GP12_AR1440_Standard.STEP-1'
        ];

        const robotEntity = document.querySelector('#robot');
        robotEntity.addEventListener('model-loaded', this.onModelLoaded.bind(this));
      },

      onModelLoaded: function (e) {
        this.robot = e.detail.model;
        console.log("Modelo del robot cargado. Identificando articulaciones por nombre...");

        this.robot.traverse(node => {
          if (this.jointNames.includes(node.name)) {
            this.joints[node.name] = node;
            console.log(`- Articulación encontrada y guardada: ${node.name}`);
          }
        });

        if (Object.keys(this.joints).length < this.jointNames.length) {
          console.error("¡ALERTA! No se encontraron todas las articulaciones por su nombre.");
          return;
        }
        
        console.log("Iniciando proceso industrial...");
        this.startProcess();
      },
      
      startProcess: function() {
        if (this.placedBoxCount >= this.palletPositions.length) {
            console.log("Proceso completado. El palé está lleno.");
            return;
        }
        this.spawnAndMoveBoxOnConveyor();
      },

      spawnAndMoveBoxOnConveyor: function() {
        const boxEl = document.createElement('a-box');
        boxEl.setAttribute('color', '#B8860B');
        boxEl.setAttribute('width', 0.4);
        boxEl.setAttribute('height', 0.4);
        boxEl.setAttribute('depth', 0.4);
        boxEl.setAttribute('position', this.conveyorStartPosition);
        boxEl.setAttribute('shadow', 'cast: true');
        this.sceneEl.appendChild(boxEl);

        new TWEEN.Tween(boxEl.object3D.position)
          .to(this.pickupPosition, 3000)
          .easing(TWEEN.Easing.Linear.None)
          .onComplete(() => {
            this.pickupAndPlaceBox(boxEl);
          })
          .start();
      },

      pickupAndPlaceBox: function(currentBox) {
        // Asignamos las articulaciones a variables más cortas para legibilidad
        const base   = this.joints['GP12_BASE_AXIS_GP12_AR1440_Standard.STEP-1'];
        const s_axis = this.joints['GP12_S_AXIS_GP12_AR1440.STEP-1'];
        const l_axis = this.joints['GP12_L_AXIS_GP12_AR1440_Standard.STEP-1'];
        const u_axis = this.joints['GP12_U_AXIS_GP12_AR1440_Standard.STEP-1'];
        const r_axis = this.joints['GP12_R_AXIS_GP12_AR1440_Standard.STEP-1'];
        const gripper = this.joints['GP12_B_AXIS_GP12_AR1440_Standard.STEP-1'];

        // Secuencia de animación
        const moveToPickup = this.createTween(s_axis, { y: -90 })
            .chain(this.createTween(l_axis, { z: -35 }))
            .chain(this.createTween(u_axis, { z: 50 }))
            .chain(this.createTween(r_axis, { y: -90 }));

        const grab = this.createTween(l_axis, { z: -20 })
            .chain(this.createTween(u_axis, { z: 35 }));
            
        const moveToPallet = this.createTween(s_axis, { y: 90 }, 2000)
            .chain(this.createTween(l_axis, { z: -35 }))
            .chain(this.createTween(u_axis, { z: 50 }));

        const release = this.createTween(l_axis, { z: -20 })
            .chain(this.createTween(u_axis, { z: 35 }));
            
        const returnHome = this.createTween(s_axis, { y: 0 }, 1500)
            .chain(this.createTween(l_axis, { z: 0 }))
            .chain(this.createTween(u_axis, { z: 0 }))
            .chain(this.createTween(r_axis, { y: 0 }));

        // Encadenar secuencias y acciones
        moveToPickup.chain(grab);
        grab.chain(moveToPallet);
        moveToPallet.chain(release);
        release.chain(returnHome);

        grab.onStart(() => gripper.attach(currentBox.object3D));
        release.onStart(() => {
            this.sceneEl.object3D.attach(currentBox.object3D);
            currentBox.object3D.position.copy(this.palletPositions[this.placedBoxCount]);
        });
        returnHome.onComplete(() => {
            this.placedBoxCount++;
            this.startProcess();
        });
        
        moveToPickup.start();
      },

      createTween: function (joint, to, duration = 1200) {
        const from = { x: joint.rotation.x, y: joint.rotation.y, z: joint.rotation.z };
        const toRad = {
          x: THREE.MathUtils.degToRad(to.x ?? THREE.MathUtils.radToDeg(from.x)),
          y: THREE.MathUtils.degToRad(to.y ?? THREE.MathUtils.radToDeg(from.y)),
          z: THREE.MathUtils.degToRad(to.z ?? THREE.MathUtils.radToDeg(from.z)),
        };
        return new TWEEN.Tween(from)
          .to(toRad, duration)
          .onUpdate(() => { joint.rotation.set(from.x, from.y, from.z); })
          .easing(TWEEN.Easing.Quadratic.InOut);
      },
      
      tick: function (time) {
        TWEEN.update(time);
      }
    });
  </script>
</head>
<body>
  <a-scene background="color: #454545" robot-controller renderer="colorManagement: true; physicallyCorrectLights: true">
    <a-assets>
      <a-asset-item id="robot-arm" src="./GP12_AR1440.glb"></a-asset-item>
      
      <img id="concrete-floor" src="https://cdn.glitch.global/c67f1742-8280-4962-a78b-d547370c4a4a/Concrete031_1K_Color.jpg?v=1680522802651">
      <img id="metal-wall" src="https://cdn.glitch.global/c67f1742-8280-4962-a78b-d547370c4a4a/MetalPlates006_1K_Color.jpg?v=1680522810486">
      <img id="conveyor-texture" src="https://cdn.glitch.global/c67f1742-8280-4962-a78b-d547370c4a4a/Rubber001_1K_Color.jpg?v=1680522815664">
      <img id="wood-pallet" src="https://cdn.glitch.global/c67f1742-8280-4962-a78b-d547370c4a4a/Planks032_1K_Color.jpg?v=1680526462589">
    </a-assets>
    
    <a-entity light="type: ambient; color: #AAA; intensity: 1"></a-entity>
    <a-entity light="type: directional; color: #FFF; intensity: 0.8" position="-2 5 2"></a-entity>
    <a-entity light="type: spot; angle: 50; penumbra: 0.5; intensity: 2.5; castShadow: true;" position="0 4 0"></a-entity>
    
    <a-plane material="src: #concrete-floor; repeat: 5 5; color: #E0E0E0" position="0 0 0" rotation="-90 0 0" width="10" height="10" shadow="receive: true"></a-plane>
    <a-plane material="src: #metal-wall; repeat: 4 2; color: #D0D0D0" width="10" height="5" position="0 2.5 -5"></a-plane>
    
    <a-entity id="robot" gltf-model="#robot-arm" position="0 0 0" shadow="cast: true"></a-entity>
    
    <a-entity id="conveyor-belt" position="-1.8 0.4 0" rotation="0 90 0">
      <a-box color="#333" depth="3" height="0.6" width="0.8"></a-box>
      <a-box id="conveyor-band" material="src: #conveyor-texture; repeat: 3 1" position="0 0.35 0" depth="3" height="0.1" width="0.7"></a-box>
    </a-entity>
    
    <a-entity id="pallet" position="1.8 0 -1.5" shadow="cast: true">
        <a-box material="src: #wood-pallet" width="1.2" height="0.15" depth="1.0" position="0 0.075 0"></a-box>
    </a-entity>
    
    <a-entity camera look-controls wasd-controls position="0 1.8 4" fov="65"></a-entity>
  </a-scene>
</body>
</html>
