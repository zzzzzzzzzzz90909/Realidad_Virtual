<!DOCTYPE html>
<html>
<head>
  <title>Proceso Industrial Fluido y Realista</title>
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <script>
    AFRAME.registerComponent('proceso-industrial', {
      init: function () {
        this.boxSize = 0.6;
        this.alturaCinta = 0.2;
        this.alturaPallet = 0.1;
        
        this.brazo1 = {
          rotador: document.querySelector('#brazo-1-rotador'),
          hombro: document.querySelector('#brazo-1-hombro'),
          pinza: document.querySelector('#brazo-1-pinza')
        };
        this.brazo2 = {
          rotador: document.querySelector('#brazo-2-rotador'),
          hombro: document.querySelector('#brazo-2-hombro'),
          pinza: document.querySelector('#brazo-2-pinza')
        };
        
        this.escena = document.querySelector('a-scene');
        this.cajaActual = null;
        this.posicionPallet = 0;
        this.posicionesDelPallet = [
          { x: 3.7, y: this.alturaPallet + this.boxSize / 2, z: -3.7 },
          { x: 4.3, y: this.alturaPallet + this.boxSize / 2, z: -3.7 },
          { x: 3.7, y: this.alturaPallet + this.boxSize / 2, z: -4.3 },
          { x: 4.3, y: this.alturaPallet + this.boxSize / 2, z: -4.3 }
        ];

        this.iniciarNuevoCiclo();
      },

      // --- SECUENCIA PRINCIPAL DEL PROCESO ---

      // 1. Inicia el ciclo creando una caja y moviendo el brazo 1
      iniciarNuevoCiclo: function () {
        const nuevaCaja = document.createElement('a-box');
        nuevaCaja.setAttribute('position', { x: -4, y: this.boxSize / 2, z: -3.5 });
        nuevaCaja.setAttribute('color', '#D2B48C');
        nuevaCaja.setAttribute('width', this.boxSize);
        nuevaCaja.setAttribute('height', this.boxSize);
        nuevaCaja.setAttribute('depth', this.boxSize);
        nuevaCaja.setAttribute('shadow', '');
        this.escena.appendChild(nuevaCaja);
        this.cajaActual = nuevaCaja;
        // Mueve el brazo a la posición de agarre (arriba)
        this.moverBrazo(this.brazo1, 'recogerInicio_arriba', this.bajarParaRecoger);
      },

      // 2. Baja el brazo para agarrar la caja
      bajarParaRecoger: function() {
        this.moverBrazo(this.brazo1, 'recogerInicio_abajo', this.recogerCaja);
      },

      // 3. Agarra la caja, la levanta y la mueve hacia la cinta
      recogerCaja: function () {
        this.brazo1.pinza.object3D.attach(this.cajaActual.object3D);
        // **CORRECCIÓN CLAVE:** Resetea la rotación de la caja para que esté derecha.
        this.cajaActual.object3D.rotation.set(0, 0, 0);
        this.moverBrazo(this.brazo1, 'soltarCinta_arriba', this.bajarParaSoltarEnCinta);
      },

      // 4. Baja el brazo para depositar la caja en la cinta
      bajarParaSoltarEnCinta: function() {
        this.moverBrazo(this.brazo1, 'soltarCinta_abajo', this.soltarCajaEnCinta);
      },

      // 5. Suelta la caja, levanta el brazo y lo regresa a su posición
      soltarCajaEnCinta: function () {
        this.escena.object3D.attach(this.cajaActual.object3D);
        this.cajaActual.setAttribute('position', { x: -2.2, y: this.alturaCinta + this.boxSize / 2, z: -3.5 });
        this.moverBrazo(this.brazo1, 'reposo');
        this.moverCajaPorCinta();
      },

      // 6. Anima la caja a lo largo de la cinta y llama al brazo 2
      moverCajaPorCinta: function() {
        this.cajaActual.setAttribute('animation__pos', { property: 'position', to: { x: 2.2, y: this.alturaCinta + this.boxSize / 2, z: -3.5 }, dur: 5000, easing: 'linear' });
        this.cajaActual.addEventListener('animationcomplete__pos', () => {
          this.moverBrazo(this.brazo2, 'recogerCinta_arriba', this.bajarParaRecogerDeCinta);
        }, { once: true });
      },
      
      // 7. (Brazo 2) Baja para recoger la caja de la cinta
      bajarParaRecogerDeCinta: function() {
        this.moverBrazo(this.brazo2, 'recogerCinta_abajo', this.recogerCajaDeCinta);
      },

      // 8. (Brazo 2) Agarra la caja, la levanta y la mueve hacia el pallet
      recogerCajaDeCinta: function() {
        this.brazo2.pinza.object3D.attach(this.cajaActual.object3D);
        this.cajaActual.object3D.rotation.set(0, 0, 0); // **CORRECCIÓN CLAVE**
        this.moverBrazo(this.brazo2, 'soltarPallet_arriba', this.bajarParaAcomodar);
      },

      // 9. (Brazo 2) Baja para acomodar la caja en el pallet
      bajarParaAcomodar: function() {
        const pose = 'soltarPallet_abajo_' + this.posicionPallet;
        this.moverBrazo(this.brazo2, pose, this.acomodarEnPallet);
      },

      // 10. (Brazo 2) Suelta la caja y reinicia el ciclo
      acomodarEnPallet: function() {
        this.escena.object3D.attach(this.cajaActual.object3D);
        const posFinal = this.posicionesDelPallet[this.posicionPallet];
        this.cajaActual.setAttribute('position', posFinal);
        this.moverBrazo(this.brazo2, 'reposo');
        this.posicionPallet = (this.posicionPallet + 1) % this.posicionesDelPallet.length;
        setTimeout(() => this.iniciarNuevoCiclo(), 1000);
      },

      // --- FUNCIÓN DE ANIMACIÓN MEJORADA ---
      moverBrazo: function (brazo, pose, callback) {
        const dur = 750; // Animación más rápida para ser más fluida
        const poses = {
          // Posiciones Brazo 1
          reposo:                 { rotador: 0,   hombro: -30 },
          recogerInicio_arriba:   { rotador: -90, hombro: -10 },
          recogerInicio_abajo:    { rotador: -90, hombro: 20  },
          soltarCinta_arriba:     { rotador: -45, hombro: -10 },
          soltarCinta_abajo:      { rotador: -45, hombro: 10  },
          // Posiciones Brazo 2
          recogerCinta_arriba:    { rotador: 45,  hombro: -10 },
          recogerCinta_abajo:     { rotador: 45,  hombro: 10  },
          soltarPallet_arriba:    { rotador: 90, hombro: -10 },
          soltarPallet_abajo_0:   { rotador: 75, hombro: 20 }, // Posición para caja 0
          soltarPallet_abajo_1:   { rotador: 105, hombro: 20 }, // Posición para caja 1
          soltarPallet_abajo_2:   { rotador: 75, hombro: 20 }, // etc...
          soltarPallet_abajo_3:   { rotador: 105, hombro: 20 }
        };
        const targetPose = poses[pose] || poses['reposo'];

        brazo.rotador.setAttribute('animation__rotacion', { property: 'rotation.y', to: targetPose.rotador, dur: dur, easing: 'easeInOutSine' });
        brazo.hombro.setAttribute('animation__inclinacion', { property: 'rotation.x', to: targetPose.hombro, dur: dur, easing: 'easeInOutSine' });

        if (callback) {
          brazo.hombro.addEventListener('animationcomplete__inclinacion', callback.bind(this), { once: true });
        }
      }
    });
  </script>
</head>
<body>
  <a-scene background="color: #283747" shadow="type: pcfsoft">
    <a-entity light="type: ambient; color: #BBB; intensity: 0.5"></a-entity>
    <a-entity light="type: directional; intensity: 0.8; castShadow: true; position: -3 5 4"></a-entity>
    <a-sky color="#B0C4DE"></a-sky>

    <a-entity id="manager" proceso-industrial></a-entity>

    <a-box position="-4 0.1 -3.5" depth="1.5" width="1.5" height="0.2" color="#455A64" shadow></a-box>
    <a-entity id="brazo-1-entidad" position="-3 0 -3.5">
      <a-entity id="brazo-1-rotador">
        <a-cylinder position="0 0.5 0" radius="0.3" height="1" color="#546E7A" shadow></a-cylinder>
        <a-entity id="brazo-1-hombro" position="0 1 0">
          <a-box position="0 0 0.5" width="0.25" height="0.25" depth="1" color="#78909C" shadow></a-box>
          <a-box id="brazo-1-pinza" position="0 0 1.2" width="0.4" height="0.4" depth="0.4" color="#B0BEC5" shadow></a-box>
        </a-entity>
      </a-entity>
    </a-entity>

    <a-box id="cinta-transportadora" position="0 0.2 -3.5" width="5" height="0.1" depth="1.5" color="#333" shadow></a-box>
    <a-box position="0 0.1 -3.5" width="5" height="0.1" depth="1.6" color="#212121" shadow></a-box>
    
    <a-box id="pallet" position="4 0.1 -4" width="2" height="0.2" color="#6D4C41" shadow></a-box>
    <a-entity id="brazo-2-entidad" position="3 0 -3.5">
      <a-entity id="brazo-2-rotador">
        <a-cylinder position="0 0.5 0" radius="0.3" height="1" color="#0277BD" shadow></a-cylinder>
        <a-entity id="brazo-2-hombro" position="0 1 0">
          <a-box position="0 0 0.5" width="0.25" height="0.25" depth="1" color="#0288D1" shadow></a-box>
          <a-box id="brazo-2-pinza" position="0 0 1.2" width="0.4" height="0.4" depth="0.4" color="#4FC3F7" shadow></a-box>
        </a-entity>
      </a-entity>
    </a-entity>

    <a-plane position="0 0 0" rotation="-90 0 0" width="15" height="15" color="#616161" shadow></a-plane>
  </a-scene>
</body>
</html>

